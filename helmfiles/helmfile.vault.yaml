---
bases:
- ../config/environments.yaml
- ../config/{{ .Environment.Name }}/helmdefaults.yaml
- ../config/{{ .Environment.Name }}/repositories.yaml
---

releases:
- name: namespace-vault
  chart: {{ .Values.archetype.chart }}
  version: {{ .Values.archetype.version }}
  namespace: kube-system
  wait: true
  condition: vault.enabled
  installed: true
  labels:
    chart: namespace-vault
    component: vault
    namespace: kube-system
  values:
  - app: vault
    namespace:
      enabled: true
      name: {{ .Values.vault.namespace }}

## Vault Deployment
- name: vault
  chart: {{ .Values.vault.chart }}
  version: {{ .Values.vault.version }}
  namespace: {{ .Values.vault.namespace }}
  condition: vault.enabled
  installed: true
  labels:
    chart: vault
    component: vault
    namespace: vault
  needs:
    - kube-system/namespace-vault
  values:
  - server:
      # affinity: ""
      ha:
        enabled: true
      service: 
        type: LoadBalancer
      dev:
        enabled: true
      dataStorage:
        enabled: true
        size: 2Gi
    ui:
      enabled: true

- name: ingress-vault
  chart: {{ .Values.archetype.chart }}
  version: {{ .Values.archetype.version }}
  namespace: {{ .Values.vault.namespace }}
  condition: ingress.enabled
  installed: true
  needs:
  - kube-system/namespace-vault
  labels:
    chart: ingress-vault
    component: ingress
    namespace: vault
  values:
  - zone: internal
    app: vault-dashboard
    ingressClassMap:
      internal: {{ .Values.ingress.internal.class }}
    ingress:
      enabled: true
      tlsEnabled: true
      hosts:
      - name: vault.{{ .Values.ingress.internal.zone }}
        secretName: ingress-vault-dashboard
        config:
          http:
            paths:
            - path: "/"
              backend:
                serviceName: vault-ui
                servicePort: 8200

## Role binding needed to do vault auth
- name: vault-sa-rolebinding
  chart: incubator/raw
  namespace: vault
  condition: vault.enabled
  installed: true
  needs:
  - vault/vault
  values:
  - resources:
    - apiVersion: rbacmanager.reactiveops.io/v1beta1
      kind: RBACDefinition
      metadata:
        name: vault-sa-rolebinding
      rbacBindings:
      - name: example-service-account
        subjects:
          - kind: ServiceAccount
            name: vault
            namespace: vault
        clusterRoleBindings:
          - clusterRole: system:auth-delegator