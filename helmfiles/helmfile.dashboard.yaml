---
bases:
- ../config/environments.yaml
- ../config/helmdefaults.yaml
---

repositories:
- name: stable
  url: https://kubernetes-charts.storage.googleapis.com

releases:
- name: "kubernetes-dashboard"
  namespace: kube-system
  labels:
    chart: "kubernetes-dashboard"
    repo: "stable"
    component: "monitoring"
    namespace: "kube-system"
    vendor: "kubernetes"
  chart: "stable/kubernetes-dashboard"
  version: "1.10.1"
  wait: true
  installed: true
  values:
  - image:
      repository: k8s.gcr.io/kubernetes-dashboard-amd64
      tag: {{ env "STACK_DASHBOARD_IMAGE_TAG" | default "v1.10.1" }}
      pullPolicy: IfNotPresent
    enableInsecureLogin: {{ env "STACK_DASHBOARD_ENABLE_INSECURE_LOGIN" | default "true"}}
{{- if eq (env "STACK_DASHBOARD_ENABLE_INSECURE_LOGIN" | default "true") "true" }}
    service:
      externalPort: 80
{{- end }}
{{- if eq (env "STACK_DASHBOARD_SKIP_LOGIN" | default "true") "true" }}
    extraArgs:
      - --enable-skip-login
{{- end }}
    replicaCount: '{{ env "STACK_DASHBOARD_REPLICA_COUNT" | default 1 }}'
    resources:
      limits:
        cpu: '{{ env "STACK_DASHBOARD_LIMIT_CPU" | default "100m" }}'
        memory: '{{ env "STACK_DASHBOARD_LIMIT_MEMORY" | default "100Mi" }}'
      requests:
        cpu: '{{ env "STACK_DASHBOARD_REQUEST_CPU" | default "50m" }}'
        memory: '{{ env "STACK_DASHBOARD_REQUEST_MEMORY" | default "50Mi" }}'
    rbac:
      create: {{ .Values.kube.rbac }}
    serviceAccount:
      create: false
      name: kubernetes-dashboard
    ingress:
      enabled: false

- name: rbac-dashboard-service
  chart: incubator/raw
  namespace: "kube-system"
  installed: true
  values:
  - resources:
    - kind: RBACDefinition
      apiVersion: rbacmanager.reactiveops.io/v1beta1
      metadata:
        name: rbac-dashboard-service
      rbacBindings:
        - name: cluster-admins
          subjects:
            - kind: ServiceAccount
              name: kubernetes-dashboard
              namespace: "kube-system"
          clusterRoleBindings:
            - clusterRole: cluster-admin

{{- if .Values.stacks.ingress.installed }}
- name: ingress-dashboard
  namespace: "kube-system"
  chart: {{ .Values.archtypeChart }}
  installed: {{ .Values.stacks.ingress.installed }}
  labels:
    chart: ingress-dashboard
    component: ingress
    namespace: "kube-system"
  values:
  - project:
      team: {{ env "TEAM" | default "cicd" }}
      target: {{ env "TARGET" | default "cicd" }}
      client: {{ env "CLIENT" | default "client1" }}
    ingressInternalClass: {{ .Values.stacks.ingress.classInternal }}
    ingress:
      enabled: true
      hosts:
      - name: dashboard.{{ .Values.stacks.ingress.zoneInternal }}
        config:
          http:
            paths:
            - path: "/"
              backend:
                serviceName: kubernetes-dashboard
                servicePort: 80
{{- end }}